---
title: "Sample code for processing water balance ET data"
author: "Amyel Dale Cero"
date: "2025-10-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Sample code for processing the data

**Required data per watershed:**

1\. Annual total precipitation

2\. Annual total discharge (normalized using watershed's area)

3\. Annual water balance ET (computed as P-Q per year)

## Libraries

```{r}

library(tidyverse)     # collection of R packages designed for data science
library(here)          # for file paths relative to the project root

```

## Data 1: watershed's annual water balance ET

### a. Computation for the "abnormal" water balance ET

**Sample site:** USGS 1019000 Grand Lake Stream at Grand Lake Stream, Maine

```{r}

# Read in the sample data
WBET_data <- read.csv(here("Data", "sample_watershed_WBET.csv"))

```

**Columns:**

**TC_ET_mm** = computed water balance ET using precipitation from TerraClimate

**PRISM_ET_mm** = computed water balance ET using precipitation from PRISM

**Daymet_ET_mm** = computed water balance ET using precipitation from Daymet

```{r}

# Example: Using PRISM_ET_mm

# Compute for the mean ET
WBET_mean <- mean(WBET_data$PRISM_ET_mm, na.rm = TRUE)
  
# Compute for mean - 2SD (standard deviation)
WBET_sd <- 2 * sd(WBET_data$PRISM_ET_mm, na.rm = TRUE)
  
# Set the thresholds
Threshold_low <- WBET_mean - WBET_sd
Threshold_high <- WBET_mean + WBET_sd

# Filter the data based on the threshold:
  
# Normal data

WBET_normal <- WBET_data %>% 
  # Low ET:
  filter(PRISM_ET_mm > Threshold_low) %>% 
  # High ET
  filter(PRISM_ET_mm < Threshold_high)

# Abnormal data, low:
WBET_abnormal_low <- WBET_data %>% 
  filter(!is.na(PRISM_ET_mm)) %>% 
  filter(PRISM_ET_mm < Threshold_low)
  
# Abnormal data, high:
WBET_abnormal_high <- WBET_data %>% 
  filter(!is.na(PRISM_ET_mm)) %>% 
  filter(PRISM_ET_mm > Threshold_high)
  
# Compute for anomaly and normalize the data
WBET_normal <- WBET_normal %>% 
  mutate(PRISM_ET_mm_anomaly = (PRISM_ET_mm - mean(WBET_normal$PRISM_ET_mm, na.rm = TRUE)),
         PRISM_ET_mm_normalized = PRISM_ET_mm_anomaly / sd(PRISM_ET_mm, na.rm = TRUE))

```

The same workflow was applied in normalizing the data sets of potential WBET explanatory variables.

## Data 2: 190 sites

```{r}

sites <- read.csv(here("Data", "sites.csv"))

```

### a. Computation of slopes

```{r}

# Using the WBET data without abnormal WBET:

# Order the data frame
WBET_normal <- WBET_normal[order(WBET_normal$water_year), ]

# Do linear regression (based on PRISM WBET)
PRISM_lm <- lm(WBET_normal$PRISM_ET_mm ~ WBET_normal$water_year)

# Save the important components of the results
PRISM_WBET_intercept <- unname(coef(PRISM_lm)[1])           # intercept
PRISM_WBET_lm_slope <- unname(coef(PRISM_lm)[2])            # slope
PRISM_WBET_slope_p <- summary(PRISM_lm)$coefficients[2,4]   # p-value of the slope
PRISM_WBET_adjr2 <- summary(PRISM_lm)$adj.r.squared         # model's adjusted R2

```

These values should be saved for each watershed.

### b. Regression between explanatory variable (x) and water balance ET (y)

```{r}


```

