---
title: "Sample code for processing water balance ET data"
author: "Amyel Dale Cero"
date: "2025-10-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Sample code for processing the data

**Required data per watershed:**

1\. Annual total precipitation

2\. Annual total discharge (normalized using watershed's area)

3\. Annual water balance ET (computed as P-Q per year)

## Libraries

```{r}

library(tidyverse)     # collection of R packages designed for data science
library(here)          # for file paths relative to the project root

```

## Data 1: watershed's annual water balance ET

### a. Computation for the "abnormal" water balance ET

```{r}

# Read in the sample data
WBET_data <- read.csv(here("Data", "sample_watershed_WBET.csv"))

```

**Columns:**

**TC_ET_mm** = computed water balance ET using precipitation from TerraClimate

**PRISM_ET_mm** = computed water balance ET using precipitation from PRISM

**Daymet_ET_mm** = computed water balance ET using precipitation from Daymet

```{r}

# Example: TC_ET_mm

# Compute for the mean ET
WBET_mean <- mean(WBET_data$TC_ET_mm, na.rm = TRUE)
  
# Compute for mean - 2SD (standard deviation)
WBET_sd <- 2 * sd(WBET_data$TC_ET_mm, na.rm = TRUE)
  
# Set the thresholds
Threshold_low <- WBET_mean - WBET_sd
Threshold_high <- WBET_mean + WBET_sd

# Filter the data based on the threshold:
  
# Normal data

WBET_normal <- WBET_data %>% 
  # Low ET:
  filter(TC_ET_mm > Threshold_low) %>% 
  # High ET
  filter(TC_ET_mm < Threshold_high)

# Abnormal data, low:
WBET_abnormal_low <- WBET_data %>% 
  filter(!is.na(TC_ET_mm)) %>% 
  filter(TC_ET_mm < Threshold_low)
  
# Abnormal data, high:
WBET_abnormal_high <- WBET_data %>% 
  filter(!is.na(TC_ET_mm)) %>% 
  filter(TC_ET_mm > Threshold_high)
  
# Compute for anomaly and normalize the data
WBET_normal <- WBET_normal %>% 
  mutate(TC_ET_mm_anomaly = (TC_ET_mm - mean(WBET_normal$TC_ET_mm, na.rm = TRUE)),
         TC_ET_mm_normalized = TC_ET_mm_anomaly / sd(TC_ET_mm, na.rm = TRUE))

```

The same workflow was applied in normalizing the data sets of potential WBET explanatory variables.

## Data 2: 190 sites

```{r}

sites <- read.csv(here("Data", "sites.csv"))

```

## a. Computation of slopes

```{r}

# Order the data frame

```

